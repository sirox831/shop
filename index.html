<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WAYY SHOP</title>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* Style Dasar */
        :root {
            --bg-color: #f2f6fa;
            --card-bg: #ffffff;
            --text-color: #333333;
            --header-bg: #2196f3;
            --input-bg: #ffffff;
            --input-border: #dddddd;
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --header-bg: #1a73e8;
            --input-bg: #2d2d2d;
            --input-border: #444444;
        }

        body { margin:0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg-color); color: var(--text-color); transition: 0.3s; }
        header { background: var(--header-bg); color: #fff; padding: 15px; font-weight: bold; text-align: center; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .container { padding:15px; max-width: 600px; margin: 0 auto; }
        
        /* Card & Product Style */
        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 8px rgba(0,0,0,.1); display: flex; align-items: center; gap: 15px; transition: 0.3s; color: var(--text-color); }
        .card.click:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); cursor:pointer; }
        .card-content { flex-grow: 1; }
        .prod-img { width: 70px; height: 70px; border-radius: 10px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .price { color:#2196f3; font-weight:bold; }
        .stock { float:right; padding:4px 10px; border-radius:20px; color:#fff; font-size:12px; }
        .Ada { background:#4caf50; }
        .Habis { background:#f44336; }

        /* Form & Button Style */
        button { width:100%; padding:12px; border:none; border-radius:10px; background:#2196f3; color:#fff; margin-top:8px; cursor:pointer; font-weight: bold; transition: 0.2s; }
        button.red { background:#f44336; }
        button.green { background:#4caf50; }
        button.orange { background:#ff9800; }
        button.outline { background:transparent; border:1px solid #fff; width: auto; padding: 5px 12px; font-size: 12px; }
        input, textarea, select { width:100%; padding:12px; margin-top:8px; border-radius:8px; border:1px solid var(--input-border); box-sizing: border-box; outline: none; background: var(--input-bg); color: var(--text-color); }
        .hidden { display:none; }
        .detail-img, .qris { width:100%; border-radius:12px; margin-top:10px; display: block; }
        .pay-box { background: rgba(33, 150, 243, 0.1); padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px dashed #2196f3; text-align: center; }
        
        /* Ulasan - CSS Diperbaiki */
        .review-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px solid var(--input-border);
        }
        
        .review-header {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--input-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .review-rating {
            font-size: 24px;
            font-weight: bold;
            color: #ff9800;
        }
        
        .review-count {
            font-size: 13px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .review-item {
            background: var(--card-bg);
            border: 1px solid var(--input-border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: 0.3s;
        }
        
        .review-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .review-user {
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .review-date {
            font-size: 11px;
            color: var(--text-color);
            opacity: 0.6;
            float: right;
        }
        
        .review-comment {
            color: var(--text-color);
            margin-top: 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .review-empty {
            text-align: center;
            color: var(--text-color);
            opacity: 0.7;
            padding: 40px 20px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 2px dashed var(--input-border);
        }
        
        .rev-star {
            color: #ff9800;
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .review-box { 
            margin-top: 10px; 
            padding: 10px; 
            background: rgba(0,0,0,0.05); 
            border-radius: 8px; 
            border: 1px dashed #2196f3; 
        }
        
        .reviewed-badge {
            display: inline-block;
            padding: 5px 10px;
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
            border: 1px solid #4caf50;
        }
        
        .review-btn {
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 20px;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            color: white;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            display: inline-block;
        }
        
        .review-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.3);
        }

        /* Floating Contact */
        .fab-contact { position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background-color: #25d366; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; z-index: 999; transition: transform 0.2s; }
        .fab-contact:hover { transform: scale(1.1); }
        .fab-contact svg { fill: white; width: 30px; height: 30px; }
        
        .theme-toggle { cursor: pointer; font-size: 20px; margin-right: 10px; user-select: none; }
    </style>
</head>

<body>

<header>
  <div style="display:flex; align-items:center">
      <span class="theme-toggle" onclick="toggleTheme()" id="themeBtn">üåô</span>
      <span onclick="window.location.href=window.location.pathname" style="cursor:pointer">üõí WAYY SHOP</span>
  </div>
  <button id="btnHistoryHeader" class="outline" onclick="showHistoryPage()">Riwayat</button>
</header>

<div class="container" id="shopPage">
    <div id="list"></div>
</div>

<div class="container hidden" id="historyPage">
    <button onclick="backToShop()">Kembali Belanja</button>
    <h3 style="color: var(--text-color)">Riwayat Pesanan Anda</h3>
    <div id="historyList"></div>
</div>

<div class="container hidden" id="detailPage">
    <button onclick="backToShop()">Kembali</button>
    <img id="dImg" class="detail-img">
    <h3 id="dName"></h3>
    <p class="price" id="dPrice"></p>
    <p id="dDesc" style="white-space: pre-line; opacity: 0.8;"></p>
    <div class="review-section">
        <h4 style="margin-bottom:10px">Ulasan Pembeli</h4>
        <div id="reviewContainer">Memuat ulasan...</div>
    </div>

    <input id="buyerWA" placeholder="Nomor WhatsApp Kamu (628xxx)">
    <input id="buyerUser" placeholder="Username / Nama Kamu">
    
    <label style="display:block; margin-top:10px; font-weight:bold">Pilih Pembayaran:</label>
    <select id="payMethod" onchange="updatePayInfo()">
        <option value="qris">QRIS</option>
        <option value="dana">DANA</option>
        <option value="gopay">GoPay</option>
    </select>

    <div id="paymentArea" class="hidden">
        <div id="payInstruction" class="pay-box"></div>
        <img id="qrisImg" class="qris hidden">
        <button id="doneBtn" class="green" onclick="done()">Saya Sudah Transfer</button>
    </div>
    
    <button id="btnOrderInitial" onclick="showPayment()">Lanjut Pembayaran</button>
</div>

<div class="container hidden" id="adminPage">
    <h3>Admin Panel</h3>
    <button class="red" onclick="logout()">Logout</button>
    <hr>
    <select id="editProduct" onchange="loadSelectedProduct()">
        <option value="">‚ûï Produk Baru</option>
    </select>
    <input id="aName" placeholder="Nama Produk">
    <input id="aPrice" placeholder="Harga">
    <textarea id="aDesc" placeholder="Deskripsi"></textarea>
    <input id="aImg" placeholder="Link Gambar Produk" oninput="showPreview(this.value)">
    <img id="previewAdmin" style="width: 80px; height: 80px; object-fit: cover; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; display:none;">
    <input id="aQris" placeholder="Link Gambar QRIS">
    <input id="aDana" placeholder="Nomor DANA">
    <input id="aGopay" placeholder="Nomor GoPay">
    <select id="aStock"><option value="Tersedia">Tersedia</option><option value="Habis">Habis</option></select>
    <button class="green" onclick="saveProduct()">Simpan Produk</button>
    <button id="btnDelete" class="red hidden" onclick="deleteProduct()">Hapus Produk</button>
    <hr>
    <h4>Order Masuk</h4>
    <div id="orders"></div>
</div>

<script>
// ================= FIREBASE CONFIG =================
const firebaseConfig = {
  apiKey: "AIzaSyDeyfth-0IOkgdMXw5zd1L6IgsKH7Q7cNg",
  authDomain: "shop-1baf8.firebaseapp.com",
  databaseURL: "https://shop-1baf8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "shop-1baf8",
  storageBucket: "shop-1baf8.firebasestorage.app",
  messagingSenderId: "417773015016",
  appId: "1:417773015016:web:1dbd85e004708b43de1e5d"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
const ADMIN_WA = "6287845688904"; 

let currentProduct = null;
let editId = null;

// ================= THEME LOGIC =================
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    const newTheme = currentTheme === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", newTheme);
    document.getElementById("themeBtn").innerText = newTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
    localStorage.setItem("theme", newTheme);
}

// Set Theme Initial
const savedTheme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", savedTheme);

// ================= NAVIGATION & LOAD DATA =================
window.onload = function() {
    document.getElementById("themeBtn").innerText = savedTheme === "dark" ? "‚òÄÔ∏è" : "üåô";
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('admin')) {
        auth.onAuthStateChanged(user => { user ? showAdminUI() : adminLogin(); });
    } else {
        loadShopData();
    }
};

function loadShopData() {
    db.ref("products").on("value", snap => {
        const listDiv = document.getElementById("list");
        const dropdown = document.getElementById("editProduct");
        if(listDiv) listDiv.innerHTML = "";
        if(dropdown) dropdown.innerHTML = '<option value="">‚ûï Produk Baru</option>';
        snap.forEach(c => {
            let p = c.val();
            if(listDiv) {
                listDiv.innerHTML += `
                <div class="card click" onclick="openProductDetail('${c.key}')">
                  <img src="${p.img || ''}" class="prod-img">
                  <div class="card-content">
                    <b>${p.name}</b> <span class="stock ${p.stock}">${p.stock}</span>
                    <div class="price">Rp${p.price}</div>
                  </div>
                </div>`;
            }
            if(dropdown) {
                let opt = document.createElement("option"); opt.value = c.key; opt.innerText = p.name; dropdown.appendChild(opt);
            }
        });
    });
}

function openProductDetail(id) {
    db.ref("products/" + id).once("value", s => {
        let p = s.val();
        if(p.stock === "Habis") return Swal.fire("Habis", "Stok kosong", "error");
        currentProduct = p;
        document.getElementById("shopPage").classList.add("hidden");
        document.getElementById("detailPage").classList.remove("hidden");
        document.getElementById("btnHistoryHeader").classList.add("hidden");
        document.getElementById("dImg").src = p.img || "";
        document.getElementById("dName").innerText = p.name;
        document.getElementById("dPrice").innerText = "Rp" + p.price;
        document.getElementById("dDesc").innerText = p.desc;
        document.getElementById("paymentArea").classList.add("hidden");
        document.getElementById("btnOrderInitial").classList.remove("hidden");
        muatUlasan(id);
    });
}

// ================= PAYMENT LOGIC =================
function showPayment() {
    if(!buyerWA.value || !buyerUser.value) return Swal.fire("Lengkapi Data", "Isi nomor WA dan Nama", "warning");
    document.getElementById("paymentArea").classList.remove("hidden");
    document.getElementById("btnOrderInitial").classList.add("hidden");
    updatePayInfo();
}

function updatePayInfo() {
    const method = document.getElementById("payMethod").value;
    const info = document.getElementById("payInstruction");
    const qr = document.getElementById("qrisImg");
    qr.classList.add("hidden");
    
    if(method === "qris") {
        info.innerHTML = "Silakan scan kode QRIS di bawah ini:";
        qr.src = currentProduct.qris;
        qr.classList.remove("hidden");
    } else if(method === "dana") {
        info.innerHTML = `Transfer DANA ke:<br><b>${currentProduct.dana || 'Belum diatur'}</b><br>Atas Nama Admin`;
    } else if(method === "gopay") {
        info.innerHTML = `Transfer GoPay ke:<br><b>${currentProduct.gopay || 'Belum diatur'}</b><br>Atas Nama Admin`;
    }
}

function done() {
    let method = document.getElementById("payMethod").value;
    let ref = db.ref("orders").push({
        productName: currentProduct.name, 
        price: currentProduct.price,
        buyerWA: buyerWA.value, 
        buyerUser: buyerUser.value,
        payMethod: method, 
        status: "Menunggu", 
        time: Date.now(),
        hasReviewed: false // Tambah field untuk tracking ulasan
    });
    
    let history = JSON.parse(localStorage.getItem("my_orders") || "[]");
    history.push(ref.key);
    localStorage.setItem("my_orders", JSON.stringify(history));

    Swal.fire({
        icon: "success",
        title: "Berhasil",
        text: "Pesanan diproses!",
        timer: 2000,
        showConfirmButton: false
    }).then(() => {
        let text = `Halo Admin, saya sudah transfer via *${method.toUpperCase()}*.\n\nüì¶ Produk: ${currentProduct.name}\nüí∞ Harga : Rp${currentProduct.price}\nüì± WA     : ${buyerWA.value}\nüë§ User: ${buyerUser.value}\nüÜî ID  : ${ref.key}\n\nMohon di Proses üôèüèª\n\n*CATATAN* üìå\nWAJIB MENGIRIM BUKTI TRANSFER`;
        window.open(`https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(text)}`);
        backToShop();
    });
}

// ================= HISTORY & REVIEW (DIPERBAIKI) =================
function showHistoryPage() {
    document.getElementById("shopPage").classList.add("hidden");
    document.getElementById("historyPage").classList.remove("hidden");
    const hList = document.getElementById("historyList");
    let history = JSON.parse(localStorage.getItem("my_orders") || "[]");
    
    if(history.length === 0) return hList.innerHTML = "<p style='color:var(--text-color)'>Belum ada pesanan</p>";
    
    hList.innerHTML = "";
    history.reverse().forEach(id => {
        db.ref("orders/" + id).once("value", s => {
            let d = s.val(); 
            if(!d) return;
            let statusColor = d.status === 'Selesai' ? '#4caf50' : (d.status === 'Diproses' ? '#2196f3' : '#ff9800');
            
            // Cek apakah sudah ada ulasan untuk order ini
            let hasReviewed = d.hasReviewed || false;
            let btnReview = "";
            
            if(d.status === 'Selesai' && !hasReviewed) {
                btnReview = `<div id="btn-rev-${id}"><hr><button class="review-btn" onclick="tampilFormUlasan('${id}', '${d.productName}', '${d.buyerUser}')">Beri Ulasan ‚≠ê</button></div>`;
            } else if(hasReviewed) {
                btnReview = `<hr><div class="reviewed-badge">‚úì Anda sudah memberikan ulasan</div>`;
            }
            
            hList.innerHTML += `
                <div class="card" style="display:block">
                    <b style="font-size:16px">${d.productName}</b><br>
                    <small>Harga: Rp${d.price}</small><br>
                    <span style="color:${statusColor}; font-weight:bold; font-size:12px">‚óè Status: ${d.status}</span>
                    ${btnReview}
                    <div id="form-rev-${id}"></div>
                </div>`;
        });
    });
}

function tampilFormUlasan(orderId, prodName, buyerName) {
    document.getElementById(`btn-rev-${orderId}`).style.display = "none";
    document.getElementById(`form-rev-${orderId}`).innerHTML = `
        <div class="review-box">
            <div style="margin-bottom:10px">
                <label style="display:block; margin-bottom:5px; font-weight:bold">Rating:</label>
                <select id="star-${orderId}" style="width:100%; padding:8px; border-radius:5px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--input-border)">
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5) - Sangat Baik</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4) - Baik</option>
                    <option value="3">‚≠ê‚≠ê‚≠ê (3) - Cukup</option>
                    <option value="2">‚≠ê‚≠ê (2) - Kurang</option>
                    <option value="1">‚≠ê (1) - Buruk</option>
                </select>
            </div>
            <div style="margin-bottom:10px">
                <label style="display:block; margin-bottom:5px; font-weight:bold">Ulasan:</label>
                <textarea id="text-${orderId}" placeholder="Bagaimana pengalaman Anda dengan produk ini?..." style="width:100%; min-height:80px; padding:10px; border-radius:5px; background:var(--input-bg); color:var(--text-color); border:1px solid var(--input-border)"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px">
                <button class="green" style="flex:1" onclick="kirimUlasan('${orderId}', '${prodName}', '${buyerName}')">Kirim Ulasan</button>
                <button class="red" style="flex:1" onclick="batalUlasan('${orderId}')">Batal</button>
            </div>
        </div>`;
}

function batalUlasan(orderId) {
    document.getElementById(`form-rev-${orderId}`).innerHTML = "";
    document.getElementById(`btn-rev-${orderId}`).style.display = "block";
}

async function kirimUlasan(orderId, prodName, buyerName) {
    const star = document.getElementById(`star-${orderId}`).value;
    const comment = document.getElementById(`text-${orderId}`).value;
    
    if(!comment.trim()) {
        return Swal.fire({
            icon: 'warning',
            title: 'Ulasan Kosong',
            text: 'Silakan tulis ulasan terlebih dahulu'
        });
    }
    
    if(comment.length < 10) {
        return Swal.fire({
            icon: 'warning',
            title: 'Ulasan Terlalu Pendek',
            text: 'Ulasan minimal 10 karakter'
        });
    }
    
    Swal.fire({
        title: 'Mengirim Ulasan...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
    
    try {
        // Cari product ID berdasarkan nama produk
        let productId = null;
        const productsSnap = await db.ref("products").once("value");
        productsSnap.forEach(p => {
            if(p.val().name === prodName) {
                productId = p.key;
            }
        });
        
        if(!productId) {
            throw new Error("Produk tidak ditemukan");
        }
        
        // Simpan ulasan
        await db.ref("reviews/" + productId).push({
            user: buyerName,
            star: star,
            comment: comment.trim(),
            time: Date.now(),
            orderId: orderId
        });
        
        // Tandai order sudah direview
        await db.ref("orders/" + orderId).update({
            hasReviewed: true,
            reviewedAt: Date.now()
        });
        
        Swal.fire({
            icon: 'success',
            title: 'Ulasan Terkirim!',
            text: 'Terima kasih atas ulasan Anda',
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            // Refresh halaman history
            showHistoryPage();
        });
        
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Gagal',
            text: 'Terjadi kesalahan saat mengirim ulasan'
        });
        console.error(error);
    }
}

function muatUlasan(productId) {
    const list = document.getElementById("reviewContainer");
    db.ref("reviews/" + productId).on("value", snap => {
        if(!snap.exists()) {
            list.innerHTML = "<div class='review-empty'><p>Belum ada ulasan untuk produk ini.<br>Jadilah yang pertama memberikan ulasan! ‚ú®</p></div>";
            return;
        }
        
        let reviews = [];
        snap.forEach(c => {
            reviews.push({...c.val(), id: c.key});
        });
        
        // Urutkan berdasarkan waktu (terbaru pertama)
        reviews.sort((a, b) => b.time - a.time);
        
        // Hitung rata-rata rating
        const avgRating = reviews.reduce((sum, r) => sum + parseInt(r.star), 0) / reviews.length;
        
        list.innerHTML = `
            <div class="review-header">
                <div>
                    <h5 style="margin:0; color:var(--text-color)">‚≠ê Rating Produk</h5>
                    <div class="review-count">${reviews.length} ulasan</div>
                </div>
                <div class="review-rating">
                    ${avgRating.toFixed(1)} <span style="font-size:14px; color:var(--text-color); opacity:0.7">/ 5.0</span>
                </div>
            </div>`;
        
        reviews.forEach(r => {
            const date = new Date(r.time);
            const formattedDate = date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            list.innerHTML += `
                <div class="review-item">
                    <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:5px">
                        <div>
                            <div class="rev-star" style="margin-bottom:5px">
                                ${"‚≠ê".repeat(r.star)}${"‚òÜ".repeat(5-r.star)}
                                <span style="color:#ff9800; font-weight:bold; margin-left:5px">${r.star}.0</span>
                            </div>
                            <div class="review-user">${r.user}</div>
                        </div>
                        <div class="review-date">${formattedDate}</div>
                    </div>
                    <div class="review-comment">${r.comment}</div>
                </div>`;
        });
    });
}

// ================= ADMIN LOGIC =================
async function adminLogin() {
    const { value: form } = await Swal.fire({
        title: 'Login Admin',
        html: '<input id="sw-mail" class="swal2-input" placeholder="Email"><input id="sw-pass" type="password" class="swal2-input" placeholder="Password">',
        preConfirm: () => [document.getElementById('sw-mail').value, document.getElementById('sw-pass').value]
    });
    if(form) auth.signInWithEmailAndPassword(form[0], form[1]).then(()=>location.reload()).catch(()=>Swal.fire("Gagal", "Cek kembali akun anda", "error"));
}

function showAdminUI() {
    document.getElementById("shopPage").classList.add("hidden");
    document.getElementById("adminPage").classList.remove("hidden");
    loadShopData();
    db.ref("orders").on("value", s => {
        const oDiv = document.getElementById("orders"); oDiv.innerHTML = "";
        s.forEach(o => {
            let d = o.val();
            let statusColor = d.status === 'Selesai' ? '#4caf50' : (d.status === 'Diproses' ? '#2196f3' : '#ff9800');
            oDiv.innerHTML += `<div class="card" style="display:block; border-left: 6px solid ${statusColor}"><b>${d.productName}</b><br>User: <b>${d.buyerUser}</b><br>Status: <span style="color:${statusColor}; font-weight:bold">${d.status}</span><div style="display:flex; gap:5px; margin-top:10px"><button style="width:auto;padding:8px 12px;" onclick="db.ref('orders/${o.key}/status').set('Diproses')">Proses</button><button style="width:auto;padding:8px 12px;" class="green" onclick="updateSelesai('${o.key}', ${JSON.stringify(d).replace(/"/g, '&quot;')})">Selesai</button><button style="width:auto;padding:8px 12px;" class="red" onclick="db.ref('orders/${o.key}').remove()">Hapus</button></div></div>`;
        });
    });
}


function updateSelesai(id, d) {
    db.ref('orders/' + id + '/status').set('Selesai').then(() => {
        let pesan = `*--- STRUK PEMBELIAN ---*\n\n‚úÖ *Pesanan Selesai!*\nüÜî Order: ${id}\nüë§ Nama: ${d.buyerUser}\nüì¶ Produk: ${d.productName}\nüí∞ Total: Rp${d.price}\n\nTerima kasih sudah belanja di *WAYY SHOP*!`;
        window.open(`https://wa.me/${d.buyerWA}?text=${encodeURIComponent(pesan)}`);
    });
}

function saveProduct() {
    let data = { name:aName.value, price:aPrice.value, desc:aDesc.value, img:aImg.value, qris:aQris.value, dana:aDana.value, gopay:aGopay.value, stock:aStock.value };
    editId ? db.ref("products/"+editId).set(data) : db.ref("products").push(data);
    Swal.fire("Sukses", "Data disimpan", "success");
    resetForm();
}

function loadSelectedProduct() {
    editId = document.getElementById("editProduct").value;
    if(!editId) return resetForm();
    db.ref("products/" + editId).once("value", s => {
        let p = s.val();
        aName.value=p.name; aPrice.value=p.price; aDesc.value=p.desc; aImg.value=p.img; aQris.value=p.qris; aDana.value=p.dana||""; aGopay.value=p.gopay||""; aStock.value=p.stock;
        showPreview(p.img); document.getElementById("btnDelete").classList.remove("hidden");
    });
}


function showPreview(u) { const p=document.getElementById("previewAdmin"); if(u){p.src=u;p.style.display="block"}else{p.style.display="none"} }
function resetForm() { editId=null; aName.value=aPrice.value=aDesc.value=aImg.value=aQris.value=aDana.value=aGopay.value=""; showPreview(""); document.getElementById("btnDelete").classList.add("hidden"); }
function deleteProduct() { if(confirm("Hapus produk?")) {db.ref("products/"+editId).remove(); resetForm();} }
function logout() { auth.signOut(); location.reload(); }
function backToShop() { document.getElementById("shopPage").classList.remove("hidden"); document.getElementById("historyPage").classList.add("hidden"); document.getElementById("detailPage").classList.add("hidden"); document.getElementById("btnHistoryHeader").classList.remove("hidden"); }
function contactAdmin() { window.open(`https://wa.me/${ADMIN_WA}?text=Halo%20Admin`); }

</script>

<div class="fab-contact" onclick="contactAdmin()">
    <svg viewBox="0 0 24 24"><path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z" /></svg>
</div>

</body>
</html>